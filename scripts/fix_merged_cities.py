"""
市町村合併対応 + 字(あざ)の正規化スクリプト

全国の市町村合併に対応したマッピングテーブルで住所変換を試みます。

使い方:
    python fix_merged_cities.py [データディレクトリ] [パート数]

例:
    python fix_merged_cities.py ./output 58
"""
import asyncio
import pandas as pd
import aiohttp
import urllib.parse
import re
import sys
from pathlib import Path
from tqdm.asyncio import tqdm_asyncio

sys.stdout.reconfigure(encoding='utf-8')

# 市町村合併マッピング（旧名 → 新名）
CITY_MERGERS = {
    # 北海道
    '北海道上川郡風連町': '北海道名寄市風連町',
    '北海道枝幸郡歌登町': '北海道枝幸郡枝幸町歌登',
    '北海道常呂郡留辺蘂町': '北海道北見市留辺蘂町',
    '北海道網走郡女満別町': '北海道網走郡大空町女満別',
    '北海道網走郡東藻琴村': '北海道網走郡大空町東藻琴',
    '北海道中川郡池田町': '北海道中川郡池田町',
    '北海道河西郡中札内村': '北海道河西郡中札内村',
    '北海道亀田郡七飯町': '北海道亀田郡七飯町',
    '北海道茅部郡森町': '北海道茅部郡森町',
    '北海道茅部郡砂原町': '北海道茅部郡森町砂原',
    '北海道山越郡八雲町': '北海道二海郡八雲町',
    '北海道爾志郡熊石町': '北海道二海郡八雲町熊石',
    '北海道檜山郡江差町': '北海道檜山郡江差町',
    '北海道瀬棚郡瀬棚町': '北海道久遠郡せたな町瀬棚区',
    '北海道瀬棚郡北檜山町': '北海道久遠郡せたな町北檜山区',
    '北海道久遠郡大成町': '北海道久遠郡せたな町大成区',
    '北海道空知郡上富良野町': '北海道空知郡上富良野町',
    '北海道空知郡中富良野町': '北海道空知郡中富良野町',
    '北海道空知郡南富良野町': '北海道空知郡南富良野町',
    '北海道勇払郡穂別町': '北海道勇払郡むかわ町穂別',
    '北海道勇払郡鵡川町': '北海道勇払郡むかわ町',
    '北海道白老郡白老町': '北海道白老郡白老町',
    '北海道有珠郡大滝村': '北海道伊達市大滝区',
    '北海道虻田郡虻田町': '北海道虻田郡洞爺湖町',
    '北海道虻田郡洞爺村': '北海道虻田郡洞爺湖町',
    '北海道静内郡静内町': '北海道日高郡新ひだか町静内',
    '北海道三石郡三石町': '北海道日高郡新ひだか町三石',

    # 岩手県
    '岩手県岩手郡滝沢村': '岩手県滝沢市',
    '岩手県岩手郡玉山村': '岩手県盛岡市玉山区',
    '岩手県紫波郡矢巾町': '岩手県紫波郡矢巾町',
    '岩手県稗貫郡石鳥谷町': '岩手県花巻市石鳥谷町',
    '岩手県稗貫郡大迫町': '岩手県花巻市大迫町',
    '岩手県和賀郡東和町': '岩手県花巻市東和町',
    '岩手県胆沢郡金ケ崎町': '岩手県胆沢郡金ケ崎町',
    '岩手県胆沢郡前沢町': '岩手県奥州市前沢区',
    '岩手県胆沢郡胆沢町': '岩手県奥州市胆沢区',
    '岩手県東磐井郡川崎村': '岩手県一関市川崎町',
    '岩手県東磐井郡千厩町': '岩手県一関市千厩町',
    '岩手県東磐井郡東山町': '岩手県一関市東山町',
    '岩手県東磐井郡室根村': '岩手県一関市室根町',
    '岩手県西磐井郡花泉町': '岩手県一関市花泉町',
    '岩手県西磐井郡平泉町': '岩手県西磐井郡平泉町',
    '岩手県気仙郡住田町': '岩手県気仙郡住田町',
    '岩手県上閉伊郡大槌町': '岩手県上閉伊郡大槌町',
    '岩手県下閉伊郡山田町': '岩手県下閉伊郡山田町',
    '岩手県下閉伊郡岩泉町': '岩手県下閉伊郡岩泉町',
    '岩手県下閉伊郡田野畑村': '岩手県下閉伊郡田野畑村',
    '岩手県下閉伊郡普代村': '岩手県下閉伊郡普代村',
    '岩手県下閉伊郡川井村': '岩手県宮古市川井',
    '岩手県九戸郡軽米町': '岩手県九戸郡軽米町',
    '岩手県九戸郡種市町': '岩手県九戸郡洋野町種市',
    '岩手県九戸郡大野村': '岩手県九戸郡洋野町大野',
    '岩手県二戸郡一戸町': '岩手県二戸郡一戸町',
    '岩手県二戸郡安代町': '岩手県八幡平市',
    '岩手県二戸郡浄法寺町': '岩手県二戸市浄法寺町',

    # 宮城県
    '宮城県桃生郡河北町': '宮城県石巻市',
    '宮城県桃生郡河南町': '宮城県石巻市',
    '宮城県桃生郡北上町': '宮城県石巻市',
    '宮城県桃生郡雄勝町': '宮城県石巻市',
    '宮城県桃生郡桃生町': '宮城県石巻市',
    '宮城県牡鹿郡牡鹿町': '宮城県石巻市',
    '宮城県牡鹿郡女川町': '宮城県牡鹿郡女川町',
    '宮城県本吉郡津山町': '宮城県登米市津山町',
    '宮城県本吉郡本吉町': '宮城県気仙沼市本吉町',
    '宮城県登米郡迫町': '宮城県登米市迫町',
    '宮城県登米郡登米町': '宮城県登米市登米町',
    '宮城県登米郡東和町': '宮城県登米市東和町',
    '宮城県登米郡中田町': '宮城県登米市中田町',
    '宮城県登米郡豊里町': '宮城県登米市豊里町',
    '宮城県登米郡米山町': '宮城県登米市米山町',
    '宮城県登米郡石越町': '宮城県登米市石越町',
    '宮城県登米郡南方町': '宮城県登米市南方町',
    '宮城県栗原郡築館町': '宮城県栗原市築館',
    '宮城県栗原郡若柳町': '宮城県栗原市若柳',
    '宮城県栗原郡栗駒町': '宮城県栗原市栗駒',
    '宮城県栗原郡高清水町': '宮城県栗原市高清水',
    '宮城県栗原郡一迫町': '宮城県栗原市一迫',
    '宮城県栗原郡瀬峰町': '宮城県栗原市瀬峰',
    '宮城県栗原郡鳴子町': '宮城県大崎市鳴子温泉',
    '宮城県玉造郡岩出山町': '宮城県大崎市岩出山',
    '宮城県玉造郡鳴子町': '宮城県大崎市鳴子温泉',
    '宮城県志田郡三本木町': '宮城県大崎市三本木',
    '宮城県志田郡松山町': '宮城県大崎市松山',
    '宮城県志田郡鹿島台町': '宮城県大崎市鹿島台',
    '宮城県遠田郡田尻町': '宮城県大崎市田尻',
    '宮城県遠田郡小牛田町': '宮城県遠田郡美里町',
    '宮城県遠田郡南郷町': '宮城県遠田郡美里町南郷',

    # 秋田県
    '秋田県河辺郡河辺町': '秋田県秋田市河辺',
    '秋田県河辺郡雄和町': '秋田県秋田市雄和',
    '秋田県南秋田郡昭和町': '秋田県潟上市昭和',
    '秋田県南秋田郡飯田川町': '秋田県潟上市飯田川',
    '秋田県南秋田郡天王町': '秋田県潟上市天王',
    '秋田県北秋田郡鷹巣町': '秋田県北秋田市',
    '秋田県北秋田郡合川町': '秋田県北秋田市合川',
    '秋田県北秋田郡森吉町': '秋田県北秋田市',
    '秋田県北秋田郡阿仁町': '秋田県北秋田市阿仁',
    '秋田県山本郡琴丘町': '秋田県山本郡三種町琴丘',
    '秋田県山本郡山本町': '秋田県山本郡三種町',
    '秋田県山本郡八竜町': '秋田県山本郡三種町八竜',
    '秋田県山本郡二ツ井町': '秋田県能代市二ツ井町',
    '秋田県由利郡岩城町': '秋田県由利本荘市岩城',
    '秋田県由利郡由利町': '秋田県由利本荘市',
    '秋田県由利郡西目町': '秋田県由利本荘市西目町',
    '秋田県由利郡鳥海町': '秋田県由利本荘市鳥海町',
    '秋田県由利郡東由利町': '秋田県由利本荘市東由利',
    '秋田県由利郡大内町': '秋田県由利本荘市大内',
    '秋田県由利郡矢島町': '秋田県由利本荘市矢島町',
    '秋田県仙北郡角館町': '秋田県仙北市角館町',
    '秋田県仙北郡田沢湖町': '秋田県仙北市田沢湖',
    '秋田県仙北郡西木村': '秋田県仙北市西木町',
    '秋田県仙北郡中仙町': '秋田県大仙市',
    '秋田県仙北郡協和町': '秋田県大仙市協和',
    '秋田県仙北郡西仙北町': '秋田県大仙市',
    '秋田県仙北郡南外村': '秋田県大仙市南外',
    '秋田県仙北郡仙北町': '秋田県大仙市',
    '秋田県仙北郡太田町': '秋田県大仙市太田町',
    '秋田県平鹿郡増田町': '秋田県横手市増田町',
    '秋田県平鹿郡平鹿町': '秋田県横手市平鹿町',
    '秋田県平鹿郡雄物川町': '秋田県横手市雄物川町',
    '秋田県平鹿郡大森町': '秋田県横手市大森町',
    '秋田県平鹿郡十文字町': '秋田県横手市十文字町',
    '秋田県平鹿郡山内村': '秋田県横手市山内',
    '秋田県平鹿郡大雄村': '秋田県横手市大雄',
    '秋田県雄勝郡稲川町': '秋田県湯沢市稲川町',
    '秋田県雄勝郡雄勝町': '秋田県湯沢市',
    '秋田県雄勝郡皆瀬村': '秋田県湯沢市皆瀬',

    # 山形県
    '山形県東田川郡櫛引町': '山形県鶴岡市櫛引',
    '山形県東田川郡朝日村': '山形県鶴岡市朝日',
    '山形県東田川郡羽黒町': '山形県鶴岡市羽黒町',
    '山形県西田川郡温海町': '山形県鶴岡市温海',
    '山形県飽海郡八幡町': '山形県酒田市八幡町',
    '山形県飽海郡松山町': '山形県酒田市松山',
    '山形県飽海郡平田町': '山形県酒田市',
    '山形県最上郡最上町': '山形県最上郡最上町',
    '山形県最上郡舟形町': '山形県最上郡舟形町',
    '山形県最上郡真室川町': '山形県最上郡真室川町',
    '山形県最上郡大蔵村': '山形県最上郡大蔵村',
    '山形県最上郡鮭川村': '山形県最上郡鮭川村',
    '山形県最上郡戸沢村': '山形県最上郡戸沢村',
    '山形県北村山郡大石田町': '山形県北村山郡大石田町',
    '山形県西村山郡河北町': '山形県西村山郡河北町',
    '山形県西村山郡西川町': '山形県西村山郡西川町',
    '山形県西村山郡朝日町': '山形県西村山郡朝日町',
    '山形県西村山郡大江町': '山形県西村山郡大江町',
    '山形県東村山郡山辺町': '山形県東村山郡山辺町',
    '山形県東村山郡中山町': '山形県東村山郡中山町',
    '山形県東置賜郡高畠町': '山形県東置賜郡高畠町',
    '山形県東置賜郡川西町': '山形県東置賜郡川西町',
    '山形県西置賜郡小国町': '山形県西置賜郡小国町',
    '山形県西置賜郡白鷹町': '山形県西置賜郡白鷹町',
    '山形県西置賜郡飯豊町': '山形県西置賜郡飯豊町',

    # 福島県
    '福島県安達郡本宮町': '福島県本宮市',
    '福島県安達郡白沢村': '福島県本宮市白沢',
    '福島県安達郡岩代町': '福島県二本松市岩代',
    '福島県安達郡東和町': '福島県二本松市東和',
    '福島県田村郡三春町': '福島県田村郡三春町',
    '福島県田村郡小野町': '福島県田村郡小野町',
    '福島県田村郡滝根町': '福島県田村市滝根町',
    '福島県田村郡大越町': '福島県田村市大越町',
    '福島県田村郡都路村': '福島県田村市都路町',
    '福島県田村郡常葉町': '福島県田村市常葉町',
    '福島県田村郡船引町': '福島県田村市船引町',
    '福島県双葉郡広野町': '福島県双葉郡広野町',
    '福島県双葉郡楢葉町': '福島県双葉郡楢葉町',
    '福島県双葉郡富岡町': '福島県双葉郡富岡町',
    '福島県双葉郡川内村': '福島県双葉郡川内村',
    '福島県双葉郡大熊町': '福島県双葉郡大熊町',
    '福島県双葉郡双葉町': '福島県双葉郡双葉町',
    '福島県双葉郡浪江町': '福島県双葉郡浪江町',
    '福島県双葉郡葛尾村': '福島県双葉郡葛尾村',
    '福島県相馬郡飯舘村': '福島県相馬郡飯舘村',
    '福島県相馬郡新地町': '福島県相馬郡新地町',
    '福島県相馬郡鹿島町': '福島県南相馬市鹿島区',
    '福島県相馬郡小高町': '福島県南相馬市小高区',
    '福島県岩瀬郡天栄村': '福島県岩瀬郡天栄村',
    '福島県岩瀬郡鏡石町': '福島県岩瀬郡鏡石町',
    '福島県岩瀬郡長沼町': '福島県須賀川市長沼',
    '福島県岩瀬郡岩瀬村': '福島県須賀川市岩瀬',
    '福島県西白河郡西郷村': '福島県西白河郡西郷村',
    '福島県西白河郡泉崎村': '福島県西白河郡泉崎村',
    '福島県西白河郡中島村': '福島県西白河郡中島村',
    '福島県西白河郡矢吹町': '福島県西白河郡矢吹町',
    '福島県西白河郡大信村': '福島県白河市大信',
    '福島県西白河郡表郷村': '福島県白河市表郷',
    '福島県西白河郡東村': '福島県白河市東',
    '福島県東白川郡棚倉町': '福島県東白川郡棚倉町',
    '福島県東白川郡矢祭町': '福島県東白川郡矢祭町',
    '福島県東白川郡塙町': '福島県東白川郡塙町',
    '福島県東白川郡鮫川村': '福島県東白川郡鮫川村',
    '福島県石川郡石川町': '福島県石川郡石川町',
    '福島県石川郡玉川村': '福島県石川郡玉川村',
    '福島県石川郡平田村': '福島県石川郡平田村',
    '福島県石川郡浅川町': '福島県石川郡浅川町',
    '福島県石川郡古殿町': '福島県石川郡古殿町',
    '福島県耶麻郡北塩原村': '福島県耶麻郡北塩原村',
    '福島県耶麻郡西会津町': '福島県耶麻郡西会津町',
    '福島県耶麻郡磐梯町': '福島県耶麻郡磐梯町',
    '福島県耶麻郡猪苗代町': '福島県耶麻郡猪苗代町',
    '福島県耶麻郡塩川町': '福島県喜多方市塩川町',
    '福島県耶麻郡山都町': '福島県喜多方市山都町',
    '福島県耶麻郡熱塩加納村': '福島県喜多方市熱塩加納町',
    '福島県耶麻郡高郷村': '福島県喜多方市高郷町',
    '福島県河沼郡会津坂下町': '福島県河沼郡会津坂下町',
    '福島県河沼郡湯川村': '福島県河沼郡湯川村',
    '福島県河沼郡柳津町': '福島県河沼郡柳津町',
    '福島県大沼郡三島町': '福島県大沼郡三島町',
    '福島県大沼郡金山町': '福島県大沼郡金山町',
    '福島県大沼郡昭和村': '福島県大沼郡昭和村',
    '福島県大沼郡会津美里町': '福島県大沼郡会津美里町',
    '福島県大沼郡会津高田町': '福島県大沼郡会津美里町',
    '福島県大沼郡会津本郷町': '福島県大沼郡会津美里町本郷',
    '福島県大沼郡新鶴村': '福島県大沼郡会津美里町新鶴',
    '福島県南会津郡下郷町': '福島県南会津郡下郷町',
    '福島県南会津郡檜枝岐村': '福島県南会津郡檜枝岐村',
    '福島県南会津郡只見町': '福島県南会津郡只見町',
    '福島県南会津郡南郷村': '福島県南会津郡南会津町南郷',
    '福島県南会津郡伊南村': '福島県南会津郡南会津町伊南',
    '福島県南会津郡舘岩村': '福島県南会津郡南会津町舘岩',
    '福島県南会津郡田島町': '福島県南会津郡南会津町田島',

    # 静岡県（浜松以外）
    '静岡県小笠郡菊川町': '静岡県菊川市',
    '静岡県小笠郡小笠町': '静岡県菊川市小笠',
    '静岡県榛原郡榛原町': '静岡県牧之原市榛原',
    '静岡県榛原郡相良町': '静岡県牧之原市',
    '静岡県磐田郡浅羽町': '静岡県袋井市浅羽',
    '静岡県磐田郡福田町': '静岡県磐田市福田',
    '静岡県磐田郡竜洋町': '静岡県磐田市',
    '静岡県磐田郡豊田町': '静岡県磐田市',
    '静岡県磐田郡豊岡村': '静岡県磐田市',
    '静岡県周智郡春野町': '静岡県浜松市天竜区春野町',
    '静岡県引佐郡引佐町': '静岡県浜松市浜名区引佐町',
    '静岡県引佐郡細江町': '静岡県浜松市浜名区細江町',
    '静岡県引佐郡三ケ日町': '静岡県浜松市浜名区三ヶ日町',
    '静岡県浜名郡雄踏町': '静岡県浜松市中央区雄踏町',
    '静岡県浜名郡舞阪町': '静岡県浜松市中央区舞阪町',
    '静岡県浜名郡新居町': '静岡県湖西市新居町',
    '静岡県天竜市': '静岡県浜松市天竜区',
    '静岡県磐田郡水窪町': '静岡県浜松市天竜区水窪町',
    '静岡県磐田郡佐久間町': '静岡県浜松市天竜区佐久間町',
    '静岡県磐田郡龍山村': '静岡県浜松市天竜区龍山町',
    '静岡県周智郡森町': '静岡県周智郡森町',
    '静岡県田方郡修善寺町': '静岡県伊豆市修善寺',
    '静岡県田方郡土肥町': '静岡県伊豆市土肥',
    '静岡県田方郡天城湯ケ島町': '静岡県伊豆市',
    '静岡県田方郡中伊豆町': '静岡県伊豆市',
    '静岡県田方郡戸田村': '静岡県沼津市戸田',
    '静岡県賀茂郡賀茂村': '静岡県賀茂郡西伊豆町',
    '静岡県賀茂郡西伊豆町': '静岡県賀茂郡西伊豆町',
    '静岡県賀茂郡松崎町': '静岡県賀茂郡松崎町',
    '静岡県賀茂郡南伊豆町': '静岡県賀茂郡南伊豆町',
    '静岡県賀茂郡河津町': '静岡県賀茂郡河津町',
    '静岡県賀茂郡東伊豆町': '静岡県賀茂郡東伊豆町',
    '静岡県庵原郡蒲原町': '静岡県静岡市清水区蒲原',
    '静岡県庵原郡由比町': '静岡県静岡市清水区由比',
    '静岡県清水市': '静岡県静岡市清水区',
    '静岡県志太郡岡部町': '静岡県藤枝市岡部町',
    '静岡県志太郡大井川町': '静岡県焼津市',
}


def convert_merged_city(address: str) -> list:
    """市町村合併による住所変換"""
    if not address:
        return []

    variants = []
    addr = str(address)

    # マッピングテーブルから変換
    for old, new in CITY_MERGERS.items():
        if old in addr:
            converted = addr.replace(old, new)
            if converted != addr:
                variants.append(converted)
                # 変換後、さらに「大字」「字」を除去したバージョンも
                v2 = re.sub(r'大字', '', converted)
                if v2 != converted:
                    variants.append(v2)
                v3 = re.sub(r'字(?=[^\d])', '', converted)  # 「字」の後に数字が続かない場合のみ
                if v3 != converted and v3 not in variants:
                    variants.append(v3)
            break

    return variants


def normalize_aza(address: str) -> list:
    """字(あざ)の正規化"""
    if not address:
        return []

    variants = []
    addr = str(address)

    # 「大字○○」→「○○」
    v1 = re.sub(r'大字', '', addr)
    if v1 != addr:
        variants.append(v1)

    # 「字○○」→「○○」（数字の前の字は残す）
    v2 = re.sub(r'字(?=[^\d])', '', addr)
    if v2 != addr and v2 not in variants:
        variants.append(v2)

    # 「村字」→削除
    v3 = re.sub(r'村字', '', addr)
    if v3 != addr and v3 not in variants:
        variants.append(v3)

    # 番戸→番地
    v4 = re.sub(r'番戸', '番地', addr)
    if v4 != addr and v4 not in variants:
        variants.append(v4)

    # 「区字」→「区」（奥州市水沢区字... → 奥州市水沢区...）
    v5 = re.sub(r'区字', '区', addr)
    if v5 != addr and v5 not in variants:
        variants.append(v5)

    # 番地以降削除
    v6 = re.sub(r'\d+番地.*$', '', addr)
    if v6 != addr and len(v6) > 10 and v6 not in variants:
        variants.append(v6)

    # 組み合わせ
    if v1 != addr:
        v1_2 = re.sub(r'字(?=[^\d])', '', v1)
        if v1_2 != v1 and v1_2 not in variants:
            variants.append(v1_2)
        v1_3 = re.sub(r'区字', '区', v1)
        if v1_3 != v1 and v1_3 not in variants:
            variants.append(v1_3)

    return variants


def simplify_address(address: str) -> list:
    """住所を段階的に簡略化"""
    if not address:
        return []

    variants = []
    addr = str(address)

    # 号を削除
    v1 = re.sub(r'(\d+)号$', r'\1', addr)
    if v1 != addr:
        variants.append(v1)

    # 番地の○号→番地○
    v2 = re.sub(r'番地の?(\d+)号?', r'-\1', addr)
    if v2 != addr and v2 not in variants:
        variants.append(v2)

    # 番地を削除
    v3 = re.sub(r'番地', '', addr)
    if v3 != addr and v3 not in variants:
        variants.append(v3)

    # 丁目以降削除
    v4 = re.sub(r'(\d+丁目).*$', r'\1', addr)
    if v4 != addr and v4 not in variants:
        variants.append(v4)

    # 全角→半角数字
    v5 = addr.translate(str.maketrans('０１２３４５６７８９', '0123456789'))
    if v5 != addr and v5 not in variants:
        variants.append(v5)

    # ハイフン統一
    v6 = re.sub(r'[−ー‐]', '-', addr)
    if v6 != addr and v6 not in variants:
        variants.append(v6)

    return variants


async def get_coordinates(session, semaphore, address):
    """住所から緯度経度を取得"""
    base_url = 'https://msearch.gsi.go.jp/address-search/AddressSearch?q='
    encoded = urllib.parse.quote(address)

    async with semaphore:
        try:
            async with session.get(base_url + encoded, timeout=aiohttp.ClientTimeout(total=30)) as resp:
                data = await resp.json()
                if data:
                    coords = data[0]['geometry']['coordinates']
                    return {
                        'found': True,
                        'query_address': address,
                        'lat': str(coords[1]),
                        'lon': str(coords[0])
                    }
        except:
            pass
    return {'found': False}


async def try_all_variants(session, semaphore, original_address):
    """全ての変換パターンを試す"""

    # 1. 市町村合併変換
    for variant in convert_merged_city(original_address):
        result = await get_coordinates(session, semaphore, variant)
        if result['found']:
            return result

    # 2. 字の正規化
    for variant in normalize_aza(original_address):
        result = await get_coordinates(session, semaphore, variant)
        if result['found']:
            return result

    # 3. 住所簡略化
    for variant in simplify_address(original_address):
        result = await get_coordinates(session, semaphore, variant)
        if result['found']:
            return result

    # 4. 組み合わせ（市町村合併 + 字正規化）
    for merged in convert_merged_city(original_address):
        for aza in normalize_aza(merged):
            result = await get_coordinates(session, semaphore, aza)
            if result['found']:
                return result

    # 5. 組み合わせ（字正規化 + 簡略化）
    for aza in normalize_aza(original_address):
        for simple in simplify_address(aza):
            result = await get_coordinates(session, semaphore, simple)
            if result['found']:
                return result

    return {'found': False}


async def main(output_dir: Path, total_parts: int):
    semaphore = asyncio.Semaphore(100)
    connector = aiohttp.TCPConnector(limit=100)

    total_fixed = 0
    total_remain = 0

    async with aiohttp.ClientSession(connector=connector) as session:
        for part in range(1, total_parts + 1):
            files = list(output_dir.glob(f'result_*_part{part:03d}.csv'))
            if not files:
                continue
            file = files[0]
            df = pd.read_csv(file, encoding='utf-8-sig', dtype=str)

            # 「住所が見つかりません」で、まだ「近しい住所」が未取得のもの
            mask = (df['エラー'] == '住所が見つかりません') & (df['近しい住所'].fillna('') == '')
            error_indices = df[mask].index.tolist()

            if not error_indices:
                continue

            print(f'パート{part}: {len(error_indices)}件を処理中...')

            tasks = [try_all_variants(session, semaphore, df.loc[i, '住所']) for i in error_indices]
            results = await tqdm_asyncio.gather(*tasks, desc=f'Part{part}')

            fixed = 0
            for idx, res in zip(error_indices, results):
                if res['found']:
                    df.loc[idx, '近しい住所'] = res['query_address']
                    df.loc[idx, '近しい住所の緯度'] = res['lat']
                    df.loc[idx, '近しい住所の経度'] = res['lon']
                    fixed += 1

            remain = len(error_indices) - fixed
            print(f'  → {fixed}/{len(error_indices)}件で近しい住所を取得（残り{remain}件）')
            total_fixed += fixed
            total_remain += remain

            df.to_csv(file, index=False, encoding='utf-8-sig')

    print(f'\n=== 完了 ===')
    print(f'今回取得成功: {total_fixed}件')
    print(f'最終残り: {total_remain}件')


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("使い方: python fix_merged_cities.py [データディレクトリ] [パート数]")
        print("例: python fix_merged_cities.py ./output 58")
        sys.exit(1)

    output_dir = Path(sys.argv[1])
    total_parts = int(sys.argv[2]) if len(sys.argv) > 2 else 58
    asyncio.run(main(output_dir, total_parts))
